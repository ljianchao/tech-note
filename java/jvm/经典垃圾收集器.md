# 经典垃圾收集器

在谈论垃圾收集器的上下文语境中，“并行”和“并发”的理解：

- 并行（Parallel）：并行描述的是多条垃圾收集线程之间的关系，说明同一时间有多条这样的线程在协同工作，通常默认此时用户线程是处于等待状态。
- 并发（Concurrent）：并发描述的是垃圾收集器线程与用户线程之间的关系，说明同一时间垃圾收集器线程与用户线程都在运行。由于用户线程并未被冻结，所以程序仍然能响应服务请求，但由于垃圾收集器线程占用了一部分系统资源，此时应用程序的处理的吞吐量将受到一定影响。

## 新生代收集器

### Serial 收集器

Serial 收集器是采用**标记-复制**算法的**单线程工作**的新生代收集器。但它的“单线程”的意义并不仅仅是说明它会使用一个处理器或一条收集线程去完成收集工作，更重要的是强调在它进行垃圾收集时，必须**暂停其他所有的工作线程（Stop The World）**，直到它收集结束。

迄今为止， Serial 收集器依然是 HotSpot 虚拟机运行在**客户端模式**下的默认新生代收集器，有着优于其他收集器的地方：

- 简单而高效（与其他收集器的单线程相比），对于内存资源受限的环境，它是所有收集器里额外内存消耗（Memory Footprint）最小的；
- 对于单核处理器或处理器核心数较少的环境来说，Serial 收集器由于没有线程交互的开销，专心做垃圾收集自然就可以获得最高的单线程收集效率。

### ParNew 收集器

ParNew 收集器是采用**标记-复制**算法的**多线程并行工作**的新生代收集器，实质上是 Serial 收集器的多线程并行版本。它使用多条线程进行垃圾收集，同样会暂停所有用户线程（Stop The World）。

ParNew 收集器是运行在**服务端模式**下的 HotSpot 虚拟机，尤其是 JDK 7 之前的遗留系统中的首选新生代收集器，其中有一个与功能、性能无关但其实很重要的原因是：除了 Serial 收集器外（JDK 9 已取消Serial + CMS 配合），目前只有它能与 CMS 收集器配合工作。

ParNew 收集器是激活 CMS后（使用 `-XX: +UseConcMarkSweepGC` 选项）的默认新生代收集器，也可以使用 `-XX: +/-UseParNewGC` 选项（JDK 9 开始，此选项被取消）来强制指定或者禁用它。

ParNew 收集器默认开启的收集线程数与处理器核心数量相同，可以使用 `-XX: ParallelGCThreads` 参数来限制垃圾收集的线程数。

### Parallel Scavenge 收集器

Parallel Scavenge 收集器同样是采用**标记-复制**算法的**多线程并行工作**的新生代收集器。它的关注点与其他垃圾收集器不同，CMS 等垃圾收集器的关注点是尽可能地缩短垃圾收集时用户线程的停顿时间，而Parallel Scavenge 收集器的目标是**达到一个可控制的吞吐量（Throughput）**。所谓的吞吐量就是处理器用于用户代码的时间与处理器总消耗时间的比值：

```
    吞吐量 = 运行用户代码时间 / （运行用户代码时间 + 运行垃圾收集时间）
```

停顿时间越短（CMS等收集器）就越适合需要与用户交互或需要保证服务响应质量的程序，良好的响应速度能提升用户体验；而高吞吐量（Parallel Scavenge 收集器，单次的垃圾收集时间可能较长，总的垃圾收集时间较短）则可以最高效率地利用处理器资源，尽快完成程序的运算任务，主要适合**在后台运算而不需要太多交互的分析任务**。

Parallel Scavenge 收集器提供了两个参数用于精确控制吞吐量，分别是控制最大收集停顿时间的 `-XX: MaxGCPauseMillis` 参数以及直接设置吞吐量大小的 `-XX: GCTimeRatio` 参数。

`-XX：MaxGCPauseMillis` 参数允许的值是一个大于 0 的毫秒数，收集器将尽力保证内存回收花费的时间不超过用户设定值。不过大家不要异想天开地认为如果把这个参数的值设置得更小一点就能使得系统的垃圾收集速度变得更快，**垃圾收集停顿时间缩短是以牺牲吞吐量和新生代空间为代价换取的**：系统把新生代调得小一些，收集 300MB 新生代肯定比收集 500M B快，但这也直接导致垃圾收集发生得**更频繁**，原来 10 秒收集一次、每次停顿 100 毫秒，现在变成 5 秒收集一次、每次停顿 70 毫秒。停顿时间的确在下降，但吞吐量也降下来了。

`-XX：GCTimeRatio` 参数的值则应当是一个大于 0 小于 100 的整数，也就是垃圾收集时间占总时间的比率，相当于**吞吐量的倒数**。譬如把此参数设置为 19 ，那允许的最大垃圾收集时间就占总时间的 5%（即1/(1+19)），默认值为 99，即允许最大 1%（即1/(1+99)）的垃圾收集时间。

Parallel Scavenge 收集器的**自适应调节策略**是区别于 ParNew 收集器的一个重要特性。参数 `-XX: +UseAdaptiveSizePolicy` 是一个开关参数，当这个参数被激活之后，就不需要人工指定新生代的大小（-Xmn）、Eden 与 Survior 区的比例（-XX: SurvivorRatio）、晋升老年代对象大小（-XX: PretenureSizeThreshold）等细节参数了，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量。使用 Parallel Scavenge 收集器配合自适应调节策略，把内存管理的调优任务交给虚拟机去完成也许是一个不错的选择。只需要把基本的内存数据设置好（如 -Xmx 设置最大堆），然后使用 `-XX：MaxGCPauseMillis` 参数（更关注最大停顿时间）或 `-XX：GCTimeRatio` 参数（更关注吞吐量）给虚拟机设立一个优化目标，那具体细节参数的调节工作就由虚拟机完成了。

## 老生代收集器

## 混合代收集器
